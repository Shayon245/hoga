<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Upay Ticket</title>

    <!-- CSS link  -->
    <link rel="stylesheet" href="../styles/style.css">

    <!-- Icons From Font Awesome  -->
    <script src="https://kit.fontawesome.com/62445b34d6.js" crossorigin="anonymous"></script>

    <!-- Google Fonts Link  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <!-- Daisy UI and Tailwind CSS Link  -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="fonts-raleway bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-md mx-4">
        <!-- Login Card -->
        <div class="bg-white rounded-3xl shadow-xl p-6 md:p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-[#1DD100] rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-bus text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-[#1DD100] mb-2">Upay Ticket</h1>
                <p class="text-gray-600">Admin Panel Login</p>
            </div>

            <!-- Login Form -->
            <form id="adminLoginForm" class="space-y-6">
                <div>
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Email Address</span>
                        </div>
                        <input type="email" id="adminEmail" placeholder="Enter your email" class="input input-bordered w-full" required>
                    </label>
                </div>

                <div>
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text font-bold">Password</span>
                        </div>
                        <input type="password" id="adminPassword" placeholder="Enter your password" class="input input-bordered w-full" required>
                    </label>
                </div>

                <div class="flex items-center justify-between">
                    <label class="label cursor-pointer">
                        <input type="checkbox" class="checkbox checkbox-sm">
                        <span class="label-text ml-2">Remember me</span>
                    </label>
                    <a href="#" class="text-[#1DD100] hover:underline text-sm">Forgot password?</a>
                </div>

                <button type="submit" class="btn btn-success bg-[#1DD100] text-white w-full py-3 text-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
            </form>

            <!-- Back to Main Site -->
            <div class="text-center mt-6">
                <a href="../index.html" class="text-[#1DD100] hover:underline">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Main Site
                </a>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500">
            <p>&copy; 2024 Upay Ticket. All rights reserved.</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any existing notifications on page load
            const existingNotifications = document.querySelectorAll('.alert');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            // Don't run automatic API test - only test when user tries to login
            console.log('Admin login page loaded');
            
            const loginForm = document.getElementById('adminLoginForm');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('adminEmail').value.trim();
                const password = document.getElementById('adminPassword').value.trim();
                
                // Call API for authentication
                console.log('Making login request to:', '../api/auth.php');
                console.log('Request data:', {
                    action: 'admin_login',
                    email: email,
                    password: password
                });
                
                fetch('../api/auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'admin_login',
                        email: email,
                        password: password
                    })
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return response.text(); // Get raw text first
                })
                .then(responseText => {
                    console.log('Raw response:', responseText);
                    
                    // Try to parse JSON
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        throw new Error('Invalid JSON response from server');
                    }
                    
                    console.log('Parsed data:', data);
                    
                    if (data.status === 'success') {
                        // Store admin session
                        localStorage.setItem('adminToken', 'authenticated');
                        localStorage.setItem('adminEmail', email);
                        localStorage.setItem('adminUser', JSON.stringify(data.data));
                        
                        // Show success message
                        showNotification('Login successful! Redirecting...', 'success');
                        
                        // Redirect to admin panel without any error parameters
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    } else {
                        showNotification(data.message || 'Invalid email or password. Please try again.', 'error');
                        document.getElementById('adminPassword').value = '';
                    }
                })
                .catch(error => {
                    console.error('Fetch error details:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    
                    let errorMessage = 'Login failed. ';
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage += 'Unable to connect to server. Please check if XAMPP is running.';
                    } else if (error.message.includes('HTTP error')) {
                        errorMessage += `Server error: ${error.message}`;
                    } else {
                        errorMessage += error.message || 'Please try again.';
                    }
                    
                    showNotification(errorMessage, 'error');
                    document.getElementById('adminPassword').value = '';
                });
            });
        });

        function showNotification(message, type = 'info') {
            // Clear any existing notifications first
            const existingNotifications = document.querySelectorAll('.alert');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = `
                <div class="fixed top-4 right-4 z-50 alert alert-${type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'} shadow-lg">
                    <div>
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                const notificationElement = document.querySelector('.alert');
                if (notificationElement) {
                    notificationElement.remove();
                }
            }, 3000);
        }

        function testAPIConnectivity() {
            console.log('Testing API connectivity...');
            
            fetch('../api/auth.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'test'
                })
            })
            .then(response => {
                console.log('API connectivity test - Status:', response.status);
                if (response.status === 200) {
                    console.log('✅ API is reachable');
                } else {
                    console.log('⚠️ API returned non-200 status:', response.status);
                }
            })
            .catch(error => {
                console.error('❌ API connectivity test failed:', error);
                showNotification('Warning: Unable to connect to server. Please ensure XAMPP is running.', 'warning');
            });
        }
    </script>
</body>

</html> 